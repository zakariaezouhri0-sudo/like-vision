{
  "entities": {
    "ShopSettings": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ShopSettings",
      "type": "object",
      "description": "Stores the general settings and branding information for the optical shop, accessible and editable only by administrators.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the ShopSettings entity."
        },
        "shopName": {
          "type": "string",
          "description": "The official name of the optical shop, displayed throughout the application and on invoices."
        },
        "address": {
          "type": "string",
          "description": "The physical address of the optical shop."
        },
        "phone": {
          "type": "string",
          "description": "The contact phone number for the optical shop."
        },
        "icePatent": {
          "type": "string",
          "description": "The ICE / Patent number of the optical shop for legal and billing purposes."
        },
        "logoUrl": {
          "type": "string",
          "description": "URL to the shop's logo image, used for branding in the app and on PDF headers.",
          "format": "uri"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the shop settings were last updated.",
          "format": "date-time"
        },
        "updatedById": {
          "type": "string",
          "description": "Reference to the User who last updated these settings. (Relationship: User 1:N ShopSettings)"
        }
      },
      "required": [
        "id",
        "shopName",
        "address",
        "phone",
        "icePatent",
        "updatedAt",
        "updatedById"
      ]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user account within the system, distinguishing between Admin and UserCaissier roles. Authentication data is managed externally.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the User entity."
        },
        "username": {
          "type": "string",
          "description": "A unique username associated with the external authentication system for this user."
        },
        "firstName": {
          "type": "string",
          "description": "The first name of the user."
        },
        "lastName": {
          "type": "string",
          "description": "The last name of the user."
        },
        "role": {
          "type": "string",
          "description": "The role of the user, determining their access level within the application.",
          "items": {
            "type": "string"
          }
        },
        "email": {
          "type": "string",
          "description": "The email address of the user, used for contact or identification.",
          "format": "email"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the user account was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the user account information was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "username",
        "firstName",
        "lastName",
        "role",
        "createdAt",
        "updatedAt"
      ]
    },
    "CashSession": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "CashSession",
      "type": "object",
      "description": "Manages daily cash register sessions, including opening, transactions, and closure calculations.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the CashSession entity."
        },
        "openingDate": {
          "type": "string",
          "description": "The date and time when the cash session was opened.",
          "format": "date-time"
        },
        "initialBalance": {
          "type": "number",
          "description": "The initial amount of cash recorded when the session was opened."
        },
        "closingDate": {
          "type": "string",
          "description": "The date and time when the cash session was closed.",
          "format": "date-time"
        },
        "theoreticalBalance": {
          "type": "number",
          "description": "The calculated balance based on initial balance, sales, and expenses at the time of closure."
        },
        "realBalance": {
          "type": "number",
          "description": "The actual cash count entered by the user at the time of closure."
        },
        "variance": {
          "type": "number",
          "description": "The difference between the theoretical balance and the real balance at closure ('Écart')."
        },
        "status": {
          "type": "string",
          "description": "The current status of the cash session (Open or Closed)."
        },
        "openedById": {
          "type": "string",
          "description": "Reference to the User who opened this cash session. (Relationship: User 1:N CashSession)"
        },
        "closedById": {
          "type": "string",
          "description": "Reference to the User who closed this cash session. (Relationship: User 1:N CashSession)"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the cash session record was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the cash session record was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "openingDate",
        "initialBalance",
        "status",
        "openedById",
        "createdAt",
        "updatedAt"
      ]
    },
    "Transaction": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Transaction",
      "type": "object",
      "description": "Records various financial movements within a cash session, such as expenses, deposits, and contributions.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Transaction entity."
        },
        "cashSessionId": {
          "type": "string",
          "description": "Reference to the CashSession this transaction belongs to. (Relationship: CashSession 1:N Transaction)"
        },
        "type": {
          "type": "string",
          "description": "The type of financial transaction (Dépense, Versement, Apport)."
        },
        "label": {
          "type": "string",
          "description": "A descriptive label for the transaction (Libellé)."
        },
        "amount": {
          "type": "number",
          "description": "The monetary amount of the transaction."
        },
        "transactionDate": {
          "type": "string",
          "description": "The date and time when the transaction occurred.",
          "format": "date-time"
        },
        "userId": {
          "type": "string",
          "description": "Reference to the User who recorded this transaction. (Relationship: User 1:N Transaction)"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the transaction record was created.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "cashSessionId",
        "type",
        "label",
        "amount",
        "transactionDate",
        "userId",
        "createdAt"
      ]
    },
    "Client": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Client",
      "type": "object",
      "description": "Stores information about individual clients of the optical shop.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Client entity."
        },
        "firstName": {
          "type": "string",
          "description": "The first name of the client."
        },
        "lastName": {
          "type": "string",
          "description": "The last name of the client."
        },
        "phone": {
          "type": "string",
          "description": "The primary phone number of the client."
        },
        "email": {
          "type": "string",
          "description": "The email address of the client.",
          "format": "email"
        },
        "address": {
          "type": "string",
          "description": "The physical address of the client."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the client record was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the client record was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "firstName",
        "lastName",
        "createdAt",
        "updatedAt"
      ]
    },
    "Mutuelle": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Mutuelle",
      "type": "object",
      "description": "Defines the different types of health insurance (Mutuelle) accepted by the shop.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Mutuelle entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the mutuelle (e.g., CNOPS, CNSS, FAR, AXA, Autre)."
        },
        "description": {
          "type": "string",
          "description": "A more detailed description or specific name for the 'Autre' mutuelle type."
        },
        "isActive": {
          "type": "boolean",
          "description": "Indicates if the mutuelle is currently active and selectable."
        }
      },
      "required": [
        "id",
        "name",
        "isActive"
      ]
    },
    "Sale": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Sale",
      "type": "object",
      "description": "Represents a single sales transaction, acting as an invoice and linking to client, mutuelle, and cash session.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Sale entity (internal primary key)."
        },
        "invoiceNumber": {
          "type": "string",
          "description": "The auto-generated, human-readable invoice number (e.g., OPT-YYYY-XXX)."
        },
        "saleDate": {
          "type": "string",
          "description": "The date and time when the sale was finalized.",
          "format": "date-time"
        },
        "clientId": {
          "type": "string",
          "description": "Reference to the Client associated with this sale. (Relationship: Client 1:N Sale)"
        },
        "mutuelleId": {
          "type": "string",
          "description": "Reference to the Mutuelle applied to this sale. Nullable if 'Aucun'. (Relationship: Mutuelle 1:N Sale)"
        },
        "otherMutuelleName": {
          "type": "string",
          "description": "The specific name of the mutuelle if 'Autre' was selected from the Mutuelle list."
        },
        "totalAmount": {
          "type": "number",
          "description": "The total monetary amount of the sale before any advance payments."
        },
        "advancePayment": {
          "type": "number",
          "description": "The amount paid upfront by the client for this sale."
        },
        "remainingAmount": {
          "type": "number",
          "description": "The outstanding balance (Reste à payer) after the advance payment."
        },
        "cashSessionId": {
          "type": "string",
          "description": "Reference to the CashSession where this sale's payment was recorded. (Relationship: CashSession 1:N Sale)"
        },
        "soldById": {
          "type": "string",
          "description": "Reference to the User who processed this sale. (Relationship: User 1:N Sale)"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the sale record was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the sale record was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "invoiceNumber",
        "saleDate",
        "clientId",
        "totalAmount",
        "advancePayment",
        "remainingAmount",
        "cashSessionId",
        "soldById",
        "createdAt",
        "updatedAt"
      ]
    },
    "SaleItem": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "SaleItem",
      "type": "object",
      "description": "Represents an individual item or product sold within a Sale (invoice), including pricing and references to prescription details if applicable.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the SaleItem entity."
        },
        "saleId": {
          "type": "string",
          "description": "Reference to the Sale this item belongs to. (Relationship: Sale 1:N SaleItem)"
        },
        "productType": {
          "type": "string",
          "description": "The category of the product sold (e.g., Verres, Monture, Autre)."
        },
        "productName": {
          "type": "string",
          "description": "A descriptive name for the specific product (e.g., 'Verres progressifs', 'Monture Ray-Ban')."
        },
        "quantity": {
          "type": "number",
          "description": "The quantity of the product sold."
        },
        "sellingPrice": {
          "type": "number",
          "description": "The price at which the product was sold to the client (per unit)."
        },
        "purchasePrice": {
          "type": "number",
          "description": "The cost of the product from the supplier ('Prix d'achat Verres/Monture'), hidden from invoices and editable by Admin."
        },
        "margin": {
          "type": "number",
          "description": "The calculated gross margin for this item (Selling Price - Purchase Price) * Quantity."
        },
        "prescriptionId": {
          "type": "string",
          "description": "Reference to the Prescription associated with this sale item, if applicable (e.g., for 'Verres'). (Relationship: SaleItem 1:1 Prescription)"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the sale item record was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the sale item record was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "saleId",
        "productType",
        "productName",
        "quantity",
        "sellingPrice",
        "purchasePrice",
        "createdAt",
        "updatedAt"
      ]
    },
    "Prescription": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Prescription",
      "type": "object",
      "description": "Contains precise optical prescription details (Sph, Cyl, Axe, Addition, Prism) for both eyes, linked to a specific pair of lenses sold.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Prescription entity."
        },
        "saleItemId": {
          "type": "string",
          "description": "Reference to the SaleItem (lenses) this prescription is for. (Relationship: SaleItem 1:1 Prescription)"
        },
        "sphereOD": {
          "type": "number",
          "description": "Spherical power for the Right Eye (Oculus Dexter)."
        },
        "cylinderOD": {
          "type": "number",
          "description": "Cylindrical power for the Right Eye (Oculus Dexter)."
        },
        "axisOD": {
          "type": "number",
          "description": "Axis for the Right Eye (Oculus Dexter)."
        },
        "additionOD": {
          "type": "number",
          "description": "Addition power for the Right Eye (Oculus Dexter), common for progressive lenses."
        },
        "prismBaseOD": {
          "type": "string",
          "description": "Prism base direction for the Right Eye (e.g., 'up', 'down', 'in', 'out')."
        },
        "prismPowerOD": {
          "type": "number",
          "description": "Prism power for the Right Eye."
        },
        "sphereOG": {
          "type": "number",
          "description": "Spherical power for the Left Eye (Oculus Sinister)."
        },
        "cylinderOG": {
          "type": "number",
          "description": "Cylindrical power for the Left Eye (Oculus Sinister)."
        },
        "axisOG": {
          "type": "number",
          "description": "Axis for the Left Eye (Oculus Sinister)."
        },
        "additionOG": {
          "type": "number",
          "description": "Addition power for the Left Eye (Oculus Sinister), common for progressive lenses."
        },
        "prismBaseOG": {
          "type": "string",
          "description": "Prism base direction for the Left Eye (e.g., 'up', 'down', 'in', 'out')."
        },
        "prismPowerOG": {
          "type": "number",
          "description": "Prism power for the Left Eye."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the prescription record was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the prescription record was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "saleItemId",
        "sphereOD",
        "cylinderOD",
        "axisOD",
        "sphereOG",
        "cylinderOG",
        "axisOG",
        "createdAt",
        "updatedAt"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/roles_admin/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Used for Database Access Control (DBAC). An empty document exists here for each user with the 'Admin' role, allowing for simple and performant `exists()` checks in security rules to determine admin privileges.",
          "params": [
            {
              "name": "userId",
              "description": "The unique Firebase Authentication UID of the user who has the 'Admin' role."
            }
          ]
        }
      },
      {
        "path": "/shopSettings/main",
        "definition": {
          "entityName": "ShopSettings",
          "schema": {
            "$ref": "#/backend/entities/ShopSettings"
          },
          "description": "Singleton document storing the general settings and branding for the optical shop. Accessible and editable only by users with the 'Admin' role. The document ID is fixed as 'main'."
        }
      },
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores individual user profiles. Admins can manage all user accounts. Users can read their own profile (`request.auth.uid == userId`). Includes a 'role' field, though global 'Admin' role is preferably managed via '/roles_admin/{userId}' for security rule simplicity.",
          "params": [
            {
              "name": "userId",
              "description": "The unique Firebase Authentication UID of the user."
            }
          ]
        }
      },
      {
        "path": "/mutuelles/{mutuelleId}",
        "definition": {
          "entityName": "Mutuelle",
          "schema": {
            "$ref": "#/backend/entities/Mutuelle"
          },
          "description": "Stores definitions of health insurance (Mutuelle) types. Readable by all authenticated staff (Admin and UserCaissier), but editable only by users with the 'Admin' role.",
          "params": [
            {
              "name": "mutuelleId",
              "description": "The unique identifier for the Mutuelle entity."
            }
          ]
        }
      },
      {
        "path": "/clients/{clientId}",
        "definition": {
          "entityName": "Client",
          "schema": {
            "$ref": "#/backend/entities/Client"
          },
          "description": "Stores information about individual clients. Accessible and editable by all authenticated staff (Admin and UserCaissier).",
          "params": [
            {
              "name": "clientId",
              "description": "The unique identifier for the Client entity."
            }
          ]
        }
      },
      {
        "path": "/cashSessions/{cashSessionId}",
        "definition": {
          "entityName": "CashSession",
          "schema": {
            "$ref": "#/backend/entities/CashSession"
          },
          "description": "Manages daily cash register sessions. Includes `openedById` and `closedById` for ownership-based authorization by UserCaissiers (can manage their own sessions) and read-access for Admins (can view all sessions). This design facilitates QAPs by denormalizing the owner's UID for efficient filtering and rule evaluation.",
          "params": [
            {
              "name": "cashSessionId",
              "description": "The unique identifier for the CashSession entity."
            }
          ]
        }
      },
      {
        "path": "/cashSessions/{cashSessionId}/transactions/{transactionId}",
        "definition": {
          "entityName": "Transaction",
          "schema": {
            "$ref": "#/backend/entities/Transaction"
          },
          "description": "Records financial movements (expenses, deposits, contributions) within a specific cash session. Denormalizes `cashSessionId` (from parent) and `userId` (the recorder). For authorization independence and QAPs, it must also denormalize `cashSessionOpenedById` from its parent CashSession. Accessible by the session opener (`cashSessionOpenedById`) and Admins.",
          "params": [
            {
              "name": "cashSessionId",
              "description": "The unique identifier of the parent CashSession."
            },
            {
              "name": "transactionId",
              "description": "The unique identifier for the Transaction entity."
            }
          ]
        }
      },
      {
        "path": "/sales/{saleId}",
        "definition": {
          "entityName": "Sale",
          "schema": {
            "$ref": "#/backend/entities/Sale"
          },
          "description": "Represents a single sales transaction (invoice). Includes `soldById` (the User who processed the sale) and `cashSessionId`. For authorization independence and QAPs, it must denormalize `cashSessionOpenedById` (from the associated CashSession) to enable efficient rules without `get()`. Accessible by the processing user and Admins.",
          "params": [
            {
              "name": "saleId",
              "description": "The unique identifier for the Sale entity."
            }
          ]
        }
      },
      {
        "path": "/sales/{saleId}/saleItems/{saleItemId}",
        "definition": {
          "entityName": "SaleItem",
          "schema": {
            "$ref": "#/backend/entities/SaleItem"
          },
          "description": "Represents an individual item or product sold within a specific sale. Denormalizes `saleId` (from parent). For authorization independence and QAPs, it must also denormalize `saleSoldById` (from the parent Sale) and `saleCashSessionOpenedById` (from the parent Sale's denormalized data) to enable rules without `get()`. Accessible by the sale processor and Admins. The 'purchasePrice' field should have Admin-only edit access.",
          "params": [
            {
              "name": "saleId",
              "description": "The unique identifier of the parent Sale."
            },
            {
              "name": "saleItemId",
              "description": "The unique identifier for the SaleItem entity."
            }
          ]
        }
      },
      {
        "path": "/sales/{saleId}/saleItems/{saleItemId}/prescription",
        "definition": {
          "entityName": "Prescription",
          "schema": {
            "$ref": "#/backend/entities/Prescription"
          },
          "description": "Contains precise optical prescription details, representing a 1:1 relationship with a specific SaleItem (lenses). Denormalizes `saleItemId` (from parent). For full authorization independence and QAPs, it must also denormalize `saleId`, `saleSoldById`, and `saleCashSessionOpenedById` to enable rules without `get()`. Accessible by the sale processor and Admins. The document ID for this 1:1 subcollection is fixed as 'prescription'.",
          "params": [
            {
              "name": "saleId",
              "description": "The unique identifier of the grandparent Sale."
            },
            {
              "name": "saleItemId",
              "description": "The unique identifier of the parent SaleItem."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to be highly secure, scalable, and debuggable, strictly adhering to the core design principles. \n\n**Authorization Independence (CRITICAL) & Denormalization:**\nTo eliminate the need for `get()` calls in security rules—which is crucial for atomic operations and rule debuggability—authorization context is consistently denormalized. \n*   For `Transaction` documents, `cashSessionOpenedById` (the UID of the user who opened the parent cash session) will be denormalized directly into the transaction document. This allows rules to check `request.auth.uid == resource.data.cashSessionOpenedById || isAdmin()` without fetching the parent `CashSession` document. The `userId` (who recorded the transaction) is already present.\n*   Similarly, `Sale` documents will denormalize `cashSessionOpenedById` from the linked `CashSession` to enable robust authorization. The `soldById` (the user who processed the sale) is already present.\n*   `SaleItem` documents will denormalize `saleSoldById` and `saleCashSessionOpenedById` from their parent `Sale` to ensure full authorization context.\n*   `Prescription` documents, being 1:1 with `SaleItem`, will also denormalize `saleId`, `saleSoldById`, and `saleCashSessionOpenedById` from their associated `SaleItem` and `Sale` documents.\nThis strategy ensures that every document contains all necessary information to make an authorization decision locally, supporting atomic writes and simplifying security rules.\n\n**Queryable Authorization Patterns (QAPs) & Structural Segregation:**\nQAPs are achieved through a combination of structural segregation and denormalization. \n*   **User-Owned Data:** User-specific data that can be filtered by `request.auth.uid` (e.g., `CashSession`s opened by a user) includes the `openedById` field. This enables efficient queries like `db.collection('cashSessions').where('openedById', '==', request.auth.uid)` and corresponding rules. By placing `CashSession` at the top level, it allows for global `list` queries by Admins while individual UserCaissiers can list their own sessions efficiently.\n*   **Global Data with Role-Based Access:** Collections like `/mutuelles` and `/clients` are global, but security rules control access based on the user's role (Admin, UserCaissier) which is checked against the `/roles_admin/{uid}` collection for Admin status, or the `role` field in `/users/{uid}`. This structural segregation simplifies rules, for example, `allow read: if isSignedIn(); allow write: if isAdmin();` for `mutuelles`.\n*   **Nested Data:** The nesting of `Transaction` under `CashSession`, `SaleItem` under `Sale`, and `Prescription` under `SaleItem` naturally groups related data with similar access requirements. The denormalization ensures that access checks on these nested documents do not rely on fetching their parent documents, thereby enabling QAPs even for subcollections, as the necessary `ownerId` or `role` context is available within the document itself or its denormalized fields.\n\n**Database Access Control (DBAC):**\nGlobal roles are managed via dedicated collections. An 'Admin' role is determined by the existence of a document at `/roles_admin/{request.auth.uid}`, ensuring a clear, explicit, and performant check for administrative privileges without relying on custom claims or complex `get()` operations on the user profile.\n\nOverall, this design emphasizes clear ownership, explicit access patterns, and self-contained authorization logic within each document, leading to a robust, performant, and maintainable Firestore security model."
  }
}